# HashIndex\<TKey\>
- [English(GeneratedByCopilot)](#english)
- [日本語](#日本語)


## **HashIndex\<TKey\> is fast clear by versioning**

###### English

***this readme was generated by GitHub Copilot***

`HashIndex<TKey>` is a high-performance, generic hash index implementation for .NET Standard 2.1, written in C#. It is designed to efficiently map unique keys to integer indices, supporting fast lookups, insertions, and dynamic resizing. The class is suitable for scenarios where you need to associate keys with positions in an array or other data structures, and require control over memory usage and collision handling.

## Features

- **Generic Key Support**: Works with any key type that implements `IEquatable<TKey>` and is non-nullable.
- **Efficient Lookups**: Provides fast retrieval of indices for given keys.
- **Dynamic Resizing**: Automatically expands internal storage to accommodate more keys or handle excessive collisions.
- **Collision Management**: Tracks and manages hash collisions, with mechanisms to expand buckets when collision thresholds are exceeded.
- **Versioning**: Maintains a version token to detect modifications and support safe enumeration.
- **Debugging Support**: Includes methods for displaying internal state for debugging purposes.

## Basic Usage

```csharp
var index = new HashIndex<string>(capacity: 100);
// Add or get index for a key bool exists;
int idx = index.GetIndex("myKey", out exists);
if (!exists)
{
  // "myKey" was newly added at idx
}
// Try to get index without adding
if (index.TryGetIndex("myKey", out int foundIdx))
{
  // foundIdx is the index of "myKey"
}
// Access all keys
foreach (var key in index.Keys)
{
  // process key
}
// O(1)
index.Clear();
```

## Key Properties and Methods

- `Count`: Number of keys currently stored.
- `Capacity`: Maximum number of keys before resizing is needed.
- `BucketSize`: Size of the internal hash bucket array.
- `MaxCollisions`: Maximum collision distance encountered.
- `IsAddable`: Indicates if new keys can be added without resizing.
- `Keys`: Returns a read-only span of all stored keys.
- `Clear()`: Clears the index.
- `Expand(newCapacity, forceRehash)`: Expands the internal storage.
- `TryGetIndex(key, out index)`: Tries to get the index for a key.
- `GetIndex(key, out exist)`: Gets the index for a key, adding it if not present.
- `ExpandableGetIndex(key, out exist, tolerateCollisions)`: Gets the index for a key, This method is "expandable" because it automatically checks and expands the internal storage (buckets or key array) as needed, especially when the number of collisions exceeds the tolerateCollisions threshold.

## Internal Design

- Uses an array of `Meta` structures to store hash metadata and manage collisions.
- Keys are stored in a separate array, and indices are used to reference them.
- Employs open addressing and custom collision resolution strategies.
- Internal versioning helps bucket reuse and safe enumeration.

## Requirements

- .NET Standard 2.1 or later
- C# 11.0 or later

## License

This project is provided under the MIT License.

# HashIndex\<TKey\>
###### 日本語

`HashIndex<TKey>`はIEquatable\<TKey\>を実装するgenericsなTKeyに対してIndexを関連付けるclassです。
動作としては
```csharp
Dictionary<TKey, Index> dict = new(capacity: 100);
dict.TryAdd(key, dict.Count)
```
に近いです。

## 使い方
### 基本
1. `new(int capacity)`コンストラクターで追加可能な要素数を設定します。
    - 内部Bucketは(capacity*1.5)程度に設定されます。
    - `Expand(int newCapacity, bool forceRehash)` または `ExpandableGetIndex(TKey key, out bool exist, byte tolerateCollisions)` を使用しない限りは拡張されません。
2. `GetIndex(Tkey key, out bool exist)` または `ExpandableGetIndex(TKey key, out bool exist, byte tolerateCollisions)` を使用してTKeyに関連付けられたIndexの取得をします。
    - この時Indexは`Keys`の`ReadOnlySpan<TKey>`内に存在する引数`key`の場所を指します。
    - 得られたIndexは次に`Clear()`が呼び出されるまで有効です。
    - `VersionToken`を保持し比較することでIndexの有効性を高めることができます。
    - 関連付けが不要な場合は`TryGetIndex(TKey key, out Index index)`を使用してください。
3. `Clear()`を使用してすべての関連付けを解消します。
    - この操作はO(1)ですが(ushort.MaxValue - 1)回に一度O(n)(nは`BucketSize`)のフラッシュが入ります。
    - `VersionToken`はこの時更新されます。
### その他注意点
- `MaxCollisions`は`ExpandableGetIndex(TKey key, out bool exist, byte tolerateCollisions)`実行後のみ更新されます。
- `VersionToken`は連番ではありません。
- 非同期処理には対応していません。

## 制作時環境
- .NET Standard 2.1
- C# 11.0

## License
This project is provided under the MIT License.
